{% extends "layout.html" %}
{% block title %}Create User · RPC Surgical Video Library{% endblock %}

{% block content %}
<section class="mb-6">
    <h1 class="text-2xl md:text-3xl font-extrabold text-[color:var(--text)]">Create User</h1>
    <p class="muted mt-1">Add a new user to the system.</p>
</section>

<section class="grid grid-cols-1 lg:grid-cols-[2fr,1fr] gap-6">

    <!-- LEFT: Form -->
    <div class="card p-5 md:p-6 rounded-2xl">
        <form id="createUserForm" class="space-y-5" onsubmit="event.preventDefault(); createUser();">

            <!-- Identity -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label" for="fullName">Full name</label>
                    <input id="fullName" class="input w-full" placeholder="Dr. A. B. Rao" required />
                </div>
                <div>
                    <label class="label" for="username">Username</label>
                    <input id="username" class="input w-full" placeholder="ab.rao" autocomplete="username" required />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label" for="email">Email</label>
                    <input id="email" type="email" class="input w-full" placeholder="you@example.com"
                        autocomplete="email" required />
                </div>
                <div>
                    <label class="label" for="mobile">Mobile</label>
                    <input id="mobile" type="tel" class="input w-full" placeholder="+91 98xxxxxxx" autocomplete="tel" />
                </div>
            </div>

            <!-- Roles & Admin -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label" for="roleInput">Roles</label>
                    <div class="glass p-2 rounded-xl">
                        <div id="roleChips" class="flex flex-wrap gap-2 mb-2"></div>
                        <div class="flex items-center gap-2">
                            <input id="roleInput" list="rolesList" class="input w-full"
                                placeholder="Type a role and press Enter" />
                            <button type="button"
                                class="btn-ghost px-3 py-2 rounded-lg border border-[color:var(--border)]"
                                onclick="addRoleFromInput()">Add</button>
                        </div>
                        <datalist id="rolesList"></datalist>
                        <p class="muted text-xs mt-2">Examples: <em>Role.Admin</em>, <em>Role.Editor</em>,
                            <em>Role.Viewer</em></p>
                    </div>
                </div>
                <div>
                    <label class="label">Admin access</label>
                    <label class="inline-flex items-center gap-3 glass p-2 rounded-xl">
                        <input id="isAdmin" type="checkbox" class="checkbox">
                        <span class="muted">Grant <b>administrator</b> privileges</span>
                    </label>
                </div>
            </div>

            <!-- Password -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label" for="password">Password</label>
                    <div class="relative">
                        <input id="password" type="password" class="input w-full pr-16" placeholder="••••••••"
                            autocomplete="new-password" required />
                        <button type="button"
                            class="absolute right-2 top-1/2 -translate-y-1/2 text-sm muted px-2 py-1 rounded hover:bg-[color:var(--brand-50)]"
                            data-toggle="#password">Show</button>
                    </div>
                    <p id="pwHelp" class="muted text-xs mt-1">At least 8 characters; use a mix of letters, numbers, and
                        symbols.</p>
                </div>
                <div>
                    <label class="label" for="confirm">Confirm password</label>
                    <div class="relative">
                        <input id="confirm" type="password" class="input w-full pr-16" placeholder="••••••••"
                            autocomplete="new-password" required />
                        <button type="button"
                            class="absolute right-2 top-1/2 -translate-y-1/2 text-sm muted px-2 py-1 rounded hover:bg-[color:var(--brand-50)]"
                            data-toggle="#confirm">Show</button>
                    </div>
                </div>
            </div>

            <!-- Errors -->
            <div id="formErrors" class="hidden text-sm text-[color:var(--danger)]"></div>

            <!-- Actions -->
            <div class="glass p-3 rounded-xl flex flex-wrap items-center justify-end gap-2">
                <button type="button" class="btn-ghost px-4 py-2 rounded-lg border border-[color:var(--border)]"
                    onclick="document.getElementById('createUserForm').reset(); resetRoles(); resetErrors();">
                    Reset
                </button>
                <button id="btnSubmit" type="submit" class="btn btn-primary">Create user</button>
            </div>
        </form>
    </div>

    <!-- RIGHT: Quick tips -->
    <aside class="card p-5 md:p-6 rounded-2xl space-y-3">
        <h2 class="text-lg font-bold text-[color:var(--text)]">Tips</h2>
        <ul class="space-y-2 text-sm muted">
            <li>Use the person’s institutional email whenever possible.</li>
            <li>Prefer usernames that are short and unique.</li>
            <li>Assign the minimum roles needed. Only enable <b>Admin</b> when necessary.</li>
        </ul>
    </aside>

</section>

<!-- Modal Dialog -->
<div id="alertDialog" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6">
        <h2 id="alertTitle" class="text-lg font-bold mb-2">Message</h2>
        <p id="alertMessage" class="text-sm"></p>
        <div class="mt-4 flex justify-end gap-2">
            <a id="alertLink" href="#"
                class="hidden btn-ghost px-4 py-2 rounded-lg border border-[color:var(--border)]">View</a>
            <button id="alertClose"
                class="px-4 py-2 rounded bg-[color:var(--brand-600)] text-white hover:opacity-90">OK</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    (() => {
        // ---------- Config ----------
        const API_CREATE = "/api/v1/users";   // POST
        const API_ROLES = "/api/v1/roles";   // GET (optional – will fall back if missing)

        // ---------- DOM ----------
        const $ = (s, r = document) => r.querySelector(s);
        const form = $("#createUserForm");
        const fullName = $("#fullName");
        const username = $("#username");
        const email = $("#email");
        const mobile = $("#mobile");
        const isAdmin = $("#isAdmin");
        const pw = $("#password");
        const confirm = $("#confirm");
        const btnSubmit = $("#btnSubmit");
        const formErrors = $("#formErrors");

        const roleInput = $("#roleInput");
        const roleChips = $("#roleChips");
        const rolesList = $("#rolesList");

        // Dialog
        const dialog = $("#alertDialog");
        const alertTitle = $("#alertTitle");
        const alertMessage = $("#alertMessage");
        const alertClose = $("#alertClose");
        const alertLink = $("#alertLink");

        // ---------- Roles (chip set) ----------
        const roles = new Set();

        function sanitizeRole(s) {
            return String(s || "").trim().replace(/\s+/g, " ").slice(0, 50);
        }
        function addRoleFromInput() {
            const v = sanitizeRole(roleInput.value);
            if (!v) return;
            roles.add(v);
            roleInput.value = "";
            renderRoleChips();
        }
        function removeRole(v) {
            roles.delete(v);
            renderRoleChips();
        }
        function resetRoles() {
            roles.clear();
            renderRoleChips();
        }
        function renderRoleChips() {
            const frag = document.createDocumentFragment();
            if (roles.size === 0) {
                const span = document.createElement("span");
                span.className = "muted text-sm";
                span.textContent = "No roles selected";
                frag.appendChild(span);
            } else {
                [...roles].forEach(r => {
                    const chip = document.createElement("span");
                    chip.className = "chip inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-[color:var(--brand-50)] text-[color:var(--brand-700)]";
                    chip.innerHTML = `
          <span>${escapeHtml(r.replace(/^Role\./i, ""))}</span>
          <button type="button" class="ml-2 text-[color:var(--danger)]" aria-label="Remove ${escapeAttr(r)}" onclick="removeRole('${escapeAttr(r)}')">&times;</button>
        `;
                    frag.appendChild(chip);
                });
            }
            roleChips.replaceChildren(frag);
        }
        window.addRoleFromInput = addRoleFromInput;
        window.removeRole = removeRole;
        resetRoles();

        // Load datalist options (optional)
        (async function populateRoleDatalist() {
            try {
                const res = await fetch(API_ROLES, { headers: { Accept: "application/json" } });
                if (!res.ok) throw 0;
                const data = await res.json();
                const arr = Array.isArray(data) ? data : [];
                const frag = document.createDocumentFragment();
                arr.forEach(it => {
                    const name = typeof it === "string" ? it : (it.name || it.id || "");
                    if (!name) return;
                    const opt = document.createElement("option");
                    opt.value = name;
                    frag.appendChild(opt);
                });
                rolesList.replaceChildren(frag);
            } catch { /* ignore */ }
        })();

        // Enter key to add role
        roleInput?.addEventListener("keydown", (e) => {
            if (e.key === "Enter") { e.preventDefault(); addRoleFromInput(); }
        });

        // ---------- Dialog ----------
        function openDialog(title, msg, linkHref = null, linkText = "View") {
            alertTitle.textContent = title;
            alertMessage.textContent = msg;
            if (linkHref) {
                alertLink.href = linkHref;
                alertLink.textContent = linkText;
                alertLink.classList.remove("hidden");
            } else {
                alertLink.classList.add("hidden");
            }
            dialog.classList.remove("hidden");
            dialog.classList.add("flex");
        }
        function closeDialog() {
            dialog.classList.add("hidden");
            dialog.classList.remove("flex");
        }
        alertClose.addEventListener("click", closeDialog);

        // ---------- Helpers ----------
        function getToken() { return localStorage.getItem("token") || ""; }
        function withAuth(opts = {}) {
            return {
                ...opts,
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/json",
                    ...(opts.headers || {}),
                    ...(getToken() ? { "Authorization": "Bearer " + getToken() } : {})
                }
            };
        }
        function resetErrors() {
            formErrors.textContent = "";
            formErrors.classList.add("hidden");
        }
        function showErrors(msg) {
            formErrors.textContent = msg || "Please fix the errors above.";
            formErrors.classList.remove("hidden");
        }
        function escapeHtml(s) {
            return String(s)
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }
        function escapeAttr(s) { return String(s).replaceAll('"', "&quot;"); }

        // Toggle password visibility
        document.querySelectorAll("[data-toggle]").forEach(btn => {
            const input = document.querySelector(btn.getAttribute("data-toggle"));
            btn.addEventListener("click", () => {
                input.type = input.type === "password" ? "text" : "password";
                btn.textContent = input.type === "password" ? "Show" : "Hide";
            });
        });

        // ---------- Submit ----------
        window.createUser = async function createUser() {
            resetErrors();

            const body = {
                full_name: fullName.value.trim(),
                username: username.value.trim(),
                email: email.value.trim(),
                mobile: mobile.value.trim(),
                is_admin: !!isAdmin.checked,
                roles: [...roles],                       // array of strings
                password: pw.value,                         // raw; backend should hash
            };

            // Client validation
            const errs = [];
            if (!body.full_name) errs.push("Full name is required.");
            if (!body.username) errs.push("Username is required.");
            if (!body.email) errs.push("Email is required.");
            if (!body.password || body.password.length < 8) errs.push("Password must be at least 8 characters.");
            if (pw.value !== confirm.value) errs.push("Passwords do not match.");
            if (errs.length) { showErrors(errs.join(" ")); openDialog("Error", errs.join(" ")); return; }

            btnSubmit.disabled = true; btnSubmit.textContent = "Creating…";
            try {
                const res = await fetch(API_CREATE, withAuth({ method: "POST", body: JSON.stringify(body) }));
                const data = await res.json().catch(() => ({}));

                if (!res.ok || data.error) {
                    const msg = data.detail || data.message || data.error || "Failed to create user.";
                    showErrors(msg);
                    openDialog("Error", msg);
                    return;
                }

                // Expect backend to return created user object (uuid/username)
                const id = data.uuid || data.id || "";
                const link = id ? `/profile/${encodeURIComponent(id)}` : null;

                openDialog("Success", "User created successfully ✓", link, "Open profile");
                form.reset(); resetRoles(); resetErrors();
            } catch (e) {
                console.error(e);
                showErrors("Network error. Try again.");
                openDialog("Error", "Network error. Try again.");
            } finally {
                btnSubmit.disabled = false; btnSubmit.textContent = "Create user";
            }
        };
    })();
</script>
{% endblock %}