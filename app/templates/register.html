{% extends "layout.html" %}
{% block title %}Register ¬∑ RPC Surgical Video Library{% endblock %}

{% block head_extra %}
<style>
    /* small polished helpers copied from login styles */
    input.input:-webkit-autofill,
    input.input:-webkit-autofill:hover,
    input.input:-webkit-autofill:focus {
        -webkit-text-fill-color: var(--text);
        transition: background-color 5000s ease-in-out 0s;
        box-shadow: 0 0 0px 1000px color-mix(in oklab, var(--surface) 96%, transparent) inset;
    }

    .fl-label { transition: transform .18s ease, color .18s ease, top .18s ease, font-size .18s ease; }
    .elevated { box-shadow: 0 10px 30px rgba(0,0,0,.08), 0 2px 10px rgba(0,0,0,.04); border: 1px solid color-mix(in oklab, var(--border) 85%, transparent); }
    .icon-chip { width:42px;height:42px;border-radius:14px;display:grid;place-items:center;background:linear-gradient(180deg,var(--brand-500),var(--brand-600));color:#fff; }
    /* Password strength progress styling */
    progress#pwStrength { appearance: none; -webkit-appearance: none; height: 8px; border-radius: 999px; overflow: hidden; background: #e6e6e6; }
    progress#pwStrength::-webkit-progress-bar { background: transparent; }
    progress#pwStrength::-webkit-progress-value { background: linear-gradient(90deg,#ff6b6b,#ffd166,#06d6a0,#4cc9f0); }
    progress#pwStrength.strength-0::-webkit-progress-value { background: #e6e6e6; }
    progress#pwStrength.strength-1::-webkit-progress-value { background: #ff6b6b; }
    progress#pwStrength.strength-2::-webkit-progress-value { background: #ffb86b; }
    progress#pwStrength.strength-3::-webkit-progress-value { background: #06d6a0; }
    progress#pwStrength.strength-4::-webkit-progress-value { background: #4cc9f0; }
    /* make the error region focusable for assistive tech */
    #reg_error[role="alert"]{ outline: none; }
</style>
{% endblock %}

{% block content %}
<section class="w-full max-w-md mx-auto mt-16 sm:mt-20 space-y-6">
    <div class="mb-6 text-center flex flex-col items-center">
        <div class="icon-chip mb-4"><span class="text-lg font-bold">RP</span></div>
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight text-[color:var(--text)]">Create account</h1>
        <p class="muted mt-1 text-sm">Register for RPC Surgical Video Library</p>
    </div>

    <div class="card elevated rounded-2xl p-6 sm:p-8 backdrop-blur">
    <form id="registerForm" class="flex flex-col gap-5" method="post" action="{{ request.path }}" novalidate onsubmit="event.preventDefault(); submitRegister();" aria-describedby="reg_error">
            {% if csrf_token is defined %}{{ csrf_token() }}{% endif %}
            <div class="relative">
                <input id="reg_username" name="username" type="text" class="peer w-full pl-10 pr-3 pt-4 pb-2 text-[rgb(var(--text)_/_var(--tw-text-opacity))] bg-[color:var(--surface)] shadow-sm border border-[color:var(--border)] rounded-lg" placeholder=" " autocomplete="username" required />
                <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 opacity-60">üë§</span>
                <label for="reg_username" class="fl-label pointer-events-none absolute left-11 top-1/2 -translate-y-1/2 text-sm muted peer-placeholder-shown:top-1/2 peer-placeholder-shown:text-sm peer-focus:top-2 peer-focus:text-xs">Username</label>
            </div>

            <div class="relative">
                <input id="reg_email" name="email" type="email" class="peer w-full pl-10 pr-3 pt-4 pb-2 text-[rgb(var(--text)_/_var(--tw-text-opacity))] bg-[color:var(--surface)] shadow-sm border border-[color:var(--border)] rounded-lg" placeholder=" " autocomplete="email" required />
                <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 opacity-60">üìß</span>
                <label for="reg_email" class="fl-label pointer-events-none absolute left-11 top-1/2 -translate-y-1/2 text-sm muted peer-placeholder-shown:top-1/2 peer-placeholder-shown:text-sm peer-focus:top-2 peer-focus:text-xs">Email</label>
            </div>

            <div class="relative">
                <input id="reg_employee" name="employee_id" type="text" class="peer w-full pl-10 pr-3 pt-4 pb-2 text-[rgb(var(--text)_/_var(--tw-text-opacity))] bg-[color:var(--surface)] shadow-sm border border-[color:var(--border)] rounded-lg" placeholder=" " autocomplete="off" />
                <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 opacity-60">üÜî</span>
                <label for="reg_employee" class="fl-label pointer-events-none absolute left-11 top-1/2 -translate-y-1/2 text-sm muted peer-placeholder-shown:top-1/2 peer-placeholder-shown:text-sm peer-focus:top-2 peer-focus:text-xs">Employee ID (optional)</label>
            </div>

            <div class="relative">
                <input id="reg_mobile" name="mobile" type="tel" pattern="^\+?[0-9\s\-]{7,15}$" maxlength="15" inputmode="tel" class="peer w-full pl-10 pr-3 pt-4 pb-2 text-[rgb(var(--text)_/_var(--tw-text-opacity))] bg-[color:var(--surface)] shadow-sm border border-[color:var(--border)] rounded-lg" placeholder=" " autocomplete="tel" />
                <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 opacity-60">üì±</span>
                <label for="reg_mobile" class="fl-label pointer-events-none absolute left-11 top-1/2 -translate-y-1/2 text-sm muted peer-placeholder-shown:top-1/2 peer-placeholder-shown:text-sm peer-focus:top-2 peer-focus:text-xs">Mobile (optional)</label>
            </div>

            <div class="relative">
                <input id="reg_password" name="password" type="password" aria-required="true" class="peer w-full pl-10 pr-24 pt-4 pb-2 text-[rgb(var(--text)_/_var(--tw-text-opacity))] bg-[color:var(--surface)] shadow-sm border border-[color:var(--border)] rounded-lg" placeholder=" " autocomplete="new-password" required />
                <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 opacity-60">üîí</span>
                <label for="reg_password" class="fl-label pointer-events-none absolute left-11 top-1/2 -translate-y-1/2 text-sm muted peer-placeholder-shown:top-1/2 peer-placeholder-shown:text-sm peer-focus:top-2 peer-focus:text-xs">Password</label>
                <button type="button" id="reg_toggle_pwd" class="absolute right-3 top-1/2 -translate-y-1/2 text-xs px-2 py-1 rounded muted" aria-label="Show password" aria-pressed="false">Show</button>
            </div>

            <div class="relative">
                <input id="reg_confirm_password" name="confirm_password" type="password" aria-required="true" class="peer w-full pl-10 pr-20 pt-4 pb-2 text-[rgb(var(--text)_/_var(--tw-text-opacity))] bg-[color:var(--surface)] shadow-sm border border-[color:var(--border)] rounded-lg" placeholder=" " autocomplete="new-password" required aria-describedby="confirmHelp" />
                <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 opacity-60">üîÅ</span>
                <label for="reg_confirm_password" class="fl-label pointer-events-none absolute left-11 top-1/2 -translate-y-1/2 text-sm muted peer-placeholder-shown:top-1/2 peer-placeholder-shown:text-sm peer-focus:top-2 peer-focus:text-xs">Confirm password</label>
                <button type="button" id="reg_toggle_confirm" class="absolute right-3 top-1/2 -translate-y-1/2 text-xs px-2 py-1 rounded muted" aria-label="Show confirm password" aria-pressed="false">Show</button>
                <p id="confirmHelp" class="muted text-xs mt-2 sr-only">Re-enter your password to confirm.</p>
            </div>

            <!-- Password strength -->
            <div aria-hidden="false">
                <label class="sr-only" for="pwStrength">Password strength</label>
                <progress id="pwStrength" class="w-full h-2 rounded mt-1 strength-0" value="0" max="4" aria-hidden="false" aria-valuemin="0" aria-valuemax="4" aria-valuenow="0"></progress>
                <p id="pwStrengthText" class="muted text-xs mt-1">Use at least 8 characters with a mix of letters, numbers and symbols.</p>
            </div>

            <p id="reg_error" role="alert" aria-live="polite" tabindex="-1" class="mt-1 text-sm hidden text-red-600 dark:text-red-400"></p>

            <button id="regSubmit" type="submit" class="btn btn-primary w-full py-3 text-base font-semibold">Create account</button>

            <div class="text-center mt-2 text-sm">
                <span class="muted">Already have an account?</span>
                <a href="/login" class="text-[color:var(--brand-600)] ml-2">Sign in</a>
            </div>
        </form>
    </div>
</section>

{% block scripts %}
<script>
    // Improve form UX: toggles, live validation, strength meter, enable/disable submit
    (function () {
    const pwd = document.getElementById('reg_password');
    const cpwd = document.getElementById('reg_confirm_password');
    const toggle = document.getElementById('reg_toggle_pwd');
    const toggleC = document.getElementById('reg_toggle_confirm');
    const submitBtn = document.getElementById('regSubmit');
    const err = document.getElementById('reg_error');
    const strength = document.getElementById('pwStrength');
    const strengthText = document.getElementById('pwStrengthText');

        function setErr(msg) {
            if (!msg) { err.classList.add('hidden'); err.textContent = ''; }
            else { err.textContent = msg; err.classList.remove('hidden'); err.focus(); }
        }

        function toggleInputVisibility(input, btn) {
            if (!input || !btn) return;
            btn.addEventListener('click', () => {
                const isPwd = input.getAttribute('type') === 'password';
                input.setAttribute('type', isPwd ? 'text' : 'password');
                btn.textContent = isPwd ? 'Hide' : 'Show';
                btn.setAttribute('aria-pressed', String(isPwd));
            });
        }
        toggleInputVisibility(pwd, toggle);
        toggleInputVisibility(cpwd, toggleC);

        function scorePassword(s) {
            let score = 0;
            if (!s) return 0;
            if (s.length >= 8) score++;
            if (/[a-z]/.test(s) && /[A-Z]/.test(s)) score++;
            if (/\d/.test(s)) score++;
            if (/[^A-Za-z0-9]/.test(s)) score++;
            return Math.min(score, 4);
        }

        function updateStrength() {
            const s = scorePassword(pwd.value);
            strength.value = s;
            strength.setAttribute('aria-valuenow', String(s));
            // update class to style color
            strength.className = 'w-full h-2 rounded mt-1 strength-' + s;
            const labels = ['Very weak', 'Weak', 'Okay', 'Good', 'Strong'];
            strengthText.textContent = labels[s];
        }

        function validateForm() {
            setErr('');
            updateStrength();
            const emailEl = document.getElementById('reg_email');
            const usernameEl = document.getElementById('reg_username');

            const usernameVal = usernameEl ? usernameEl.value.trim() : '';
            const emailVal = emailEl ? emailEl.value.trim() : '';
            const pwdVal = pwd ? pwd.value : '';
            const cpwdVal = cpwd ? cpwd.value : '';

            // required fields
            if (!usernameVal) {
                setErr('Username is required.');
                usernameEl && usernameEl.setAttribute('aria-invalid', 'true');
                return false;
            } else { usernameEl && usernameEl.removeAttribute('aria-invalid'); }

            if (!emailVal) {
                setErr('Email is required.');
                emailEl && emailEl.setAttribute('aria-invalid', 'true');
                return false;
            } else { emailEl && emailEl.removeAttribute('aria-invalid'); }

            if (!pwdVal) {
                setErr('Password is required.');
                pwd && pwd.setAttribute('aria-invalid', 'true');
                return false;
            } else { pwd && pwd.removeAttribute('aria-invalid'); }

            // confirm validity
            if (pwdVal && cpwdVal && pwdVal !== cpwdVal) {
                cpwd.setCustomValidity('Passwords do not match.');
                setErr('Passwords do not match.');
                cpwd.setAttribute('aria-invalid', 'true');
                return false;
            } else {
                cpwd.setCustomValidity(''); cpwd.removeAttribute('aria-invalid');
            }

            if (pwdVal && pwdVal.length < 8) {
                pwd.setCustomValidity('Password must be at least 8 characters.');
                setErr('Password must be at least 8 characters.');
                pwd.setAttribute('aria-invalid', 'true');
                return false;
            } else { pwd.setCustomValidity(''); pwd.removeAttribute('aria-invalid'); }

            if (emailVal && !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(emailVal)) {
                setErr('Enter a valid email address.');
                emailEl && emailEl.setAttribute('aria-invalid', 'true');
                return false;
            } else { emailEl && emailEl.removeAttribute('aria-invalid'); }

            return true;
        }

    [pwd, cpwd, document.getElementById('reg_email'), document.getElementById('reg_username')].forEach(el => {
            if (!el) return;
            el.addEventListener('input', () => {
                const ok = validateForm();
                submitBtn.disabled = !ok;
            });
        });

    // initial state
    submitBtn.disabled = true;
    // run validation once on load to set state correctly
    document.addEventListener('DOMContentLoaded', () => {
        const ok = validateForm();
        submitBtn.disabled = !ok;
    });

        window.submitRegister = function submitRegister() {
            const ok = validateForm();
            if (!ok) return;
            // disable to prevent double submit and show progress
            submitBtn.disabled = true; const prev = submitBtn.textContent; submitBtn.textContent = 'Creating‚Ä¶';
            try {
                document.getElementById('registerForm').submit();
            } finally {
                // re-enable after a short delay if submission did not navigate
                setTimeout(() => { try { submitBtn.disabled = false; submitBtn.textContent = prev; } catch(e){} }, 2000);
            }
        };
    })();
</script>
{% endblock %}

{% endblock %}