{% extends 'layout.html' %}
{% block title %}Link Surgeons · Admin{% endblock %}
{% block content %}
<section class="mb-6">
  <h1 class="text-2xl font-bold flex items-center gap-3">
    <span class="inline-block bg-gradient-to-r from-[color:var(--brand-600)] to-[color:var(--brand-400)] text-transparent bg-clip-text">Link Surgeons to Users</span>
    <span class="hidden text-[10px] uppercase tracking-wider px-2 py-1 rounded-full bg-[color:var(--brand-100)] dark:bg-[color:var(--brand-900)] text-[color:var(--brand-600)] dark:text-[color:var(--brand-300)]">Admin Tool</span>
  </h1>
  <p class="muted mt-1 text-sm">Assign an application user to a surgeon record for ownership & attribution.</p>
</section>

<!-- Global loading indicator -->
<div id="globalLoading" class="fixed top-0 left-0 right-0 h-0.5 bg-gradient-to-r from-[color:var(--brand-600)] via-[color:var(--brand-400)] to-[color:var(--brand-600)] animate-pulse hidden z-40"></div>

<div class="grid md:grid-cols-2 gap-8 items-start">
  <!-- Surgeons Panel -->
  <div class="glass p-0 rounded-2xl flex flex-col h-full shadow-lg shadow-black/5 dark:shadow-black/30 border border-[color:var(--border)]/60 overflow-hidden">
    <!-- Toolbar -->
    <div class="p-4 pb-3 space-y-3 border-b border-[color:var(--border)]/60 bg-gradient-to-br from-[color:var(--surface)] to-[color:var(--surface-alt)]/50 sticky top-0 z-20 backdrop-blur supports-[backdrop-filter]:bg-[color:var(--surface)]/85">
      <div class="flex gap-3 w-full">
        <input id="surgeonSearch" placeholder="Search surgeons" class="input flex-1" />
        <button id="surgeonSearchBtn" class="btn btn-primary text-sm shrink-0">Search</button>
      </div>
      <div class="flex flex-wrap gap-3 items-center">
        <div id="surgeonLinkedGroup" class="seg-group" role="group" aria-label="Surgeon link filter">
          <button type="button" class="seg active" data-val="" data-active="true">All</button>
          <button type="button" class="seg" data-val="yes">Linked</button>
          <button type="button" class="seg" data-val="no">Unlinked</button>
        </div>
        <div id="surgeonSortGroup" class="flex items-stretch overflow-hidden rounded-md border border-[color:var(--border)] divide-x divide-[color:var(--border)] bg-[color:var(--surface-alt)] text-xs">
          <button type="button" data-key="id" class="px-2 py-1 sort-btn">ID<span class="ml-1 sort-arrow opacity-40">↕</span></button>
          <button type="button" data-key="name" class="px-2 py-1 sort-btn">Name<span class="ml-1 sort-arrow opacity-40">↕</span></button>
          <button type="button" data-key="type" class="px-2 py-1 sort-btn">Type<span class="ml-1 sort-arrow opacity-40">↕</span></button>
        </div>
        <div id="surgeonPageSizeGroup" class="seg-group" role="group" aria-label="Page size">
          <button type="button" class="seg" data-size="10">10</button>
          <button type="button" class="seg active" data-size="20" data-active="true">20</button>
          <button type="button" class="seg" data-size="50">50</button>
        </div>
      </div>
      <div class="flex flex-wrap gap-2 text-xs items-center pt-1">
        <button id="bulkLinkBtn" class="btn btn-ghost px-2 py-1 text-xs">Bulk Link</button>
        <button id="bulkUnlinkBtn" class="btn btn-ghost px-2 py-1 text-xs">Bulk Unlink</button>
        <button id="surgeonSelectAll" class="btn btn-ghost px-2 py-1 text-xs">Select Page</button>
        <button id="surgeonClearSel" class="btn btn-ghost px-2 py-1 text-xs">Clear</button>
        <span class="muted" id="bulkStatus"></span>
      </div>
      <div class="flex items-center justify-between text-[11px] bg-[color:var(--surface-alt)]/70 backdrop-blur-sm px-3 py-1.5 rounded-md border border-[color:var(--border)]/60">
        <label class="flex items-center gap-2 cursor-pointer select-none"><input id="surgeonMasterChk" type="checkbox" class="accent-[color:var(--brand-600)]"><span class="font-medium">Select Page</span></label>
        <div class="flex gap-2">
          <button id="invertSelection" class="btn btn-ghost px-2 py-0.5 text-[11px]">Invert</button>
        </div>
      </div>
      <div class="flex items-center justify-between text-xs mt-1">
        <span id="surgeonStats" class="muted"></span>
        <div class="flex items-center gap-2">
          <button id="surgeonPrev" class="btn btn-ghost px-2 py-0.5 text-xs">Prev</button>
          <span id="surgeonPageInfo" class="muted"></span>
          <button id="surgeonNext" class="btn btn-ghost px-2 py-0.5 text-xs">Next</button>
        </div>
      </div>
    </div>
    <!-- List -->
  <ul id="surgeonList" class="flex-1 overflow-auto max-h-[55vh] divide-y divide-[color:var(--border)] text-sm px-2 py-1 bg-gradient-to-b from-[color:var(--surface)] via-[color:var(--surface-alt)]/40 to-[color:var(--surface)]" aria-label="Surgeons list"></ul>
    <!-- Footer / Create -->
    <div class="p-4 border-t border-[color:var(--border)]/60">
      <details class="rounded-lg border border-dashed border-[color:var(--border)] px-3 py-2">
        <summary class="cursor-pointer text-sm font-medium">Create Surgeon</summary>
        <div class="mt-3 flex flex-col gap-2 animate-fade-in">
          <input id="newName" placeholder="Name" class="input" />
          <input id="newType" placeholder="Type" class="input" />
            <textarea id="newDesc" placeholder="Description" class="input"></textarea>
          <button id="createSurgeonBtn" class="btn btn-primary text-sm self-start">Create</button>
        </div>
      </details>
    </div>
  </div>

  <!-- Users Panel -->
  <div class="glass p-0 rounded-2xl flex flex-col h-full shadow-lg shadow-black/5 dark:shadow-black/30 border border-[color:var(--border)]/60 overflow-hidden">
    <!-- Toolbar -->
    <div class="p-4 pb-3 space-y-3 border-b border-[color:var(--border)]/60 bg-gradient-to-br from-[color:var(--surface)] to-[color:var(--surface-alt)]/50 sticky top-0 z-20 backdrop-blur supports-[backdrop-filter]:bg-[color:var(--surface)]/85">
      <div class="flex gap-3 w-full">
        <input id="userSearch" placeholder="Search users" class="input flex-1" />
        <button id="userSearchBtn" class="btn btn-primary text-sm shrink-0">Search</button>
      </div>
      <div class="flex flex-wrap gap-3 items-center">
        <div id="userLinkedGroup" class="seg-group" role="group" aria-label="User link filter">
          <button type="button" class="seg active" data-val="" data-active="true">All</button>
          <button type="button" class="seg" data-val="yes">With</button>
          <button type="button" class="seg" data-val="no">Without</button>
        </div>
        <div id="userSortGroup" class="flex items-stretch overflow-hidden rounded-md border border-[color:var(--border)] divide-x divide-[color:var(--border)] bg-[color:var(--surface-alt)] text-xs">
          <button type="button" data-key="created_at" class="px-2 py-1 sort-btn">Created<span class="ml-1 sort-arrow opacity-40">↕</span></button>
          <button type="button" data-key="username" class="px-2 py-1 sort-btn">Username<span class="ml-1 sort-arrow opacity-40">↕</span></button>
          <button type="button" data-key="email" class="px-2 py-1 sort-btn">Email<span class="ml-1 sort-arrow opacity-40">↕</span></button>
        </div>
        <div id="userPageSizeGroup" class="seg-group" role="group" aria-label="User page size">
          <button type="button" class="seg" data-size="10">10</button>
          <button type="button" class="seg active" data-size="20" data-active="true">20</button>
          <button type="button" class="seg" data-size="50">50</button>
        </div>
      </div>
      <div class="flex items-center justify-between text-xs mt-1">
        <span id="userStats" class="muted"></span>
        <div class="flex items-center gap-2">
          <button id="userPrev" class="btn btn-ghost px-2 py-0.5 text-xs">Prev</button>
          <span id="userPageInfo" class="muted"></span>
          <button id="userNext" class="btn btn-ghost px-2 py-0.5 text-xs">Next</button>
        </div>
      </div>
    </div>
    <!-- List -->
  <ul id="userList" class="flex-1 overflow-auto max-h-[55vh] divide-y divide-[color:var(--border)] text-sm px-2 py-1 bg-gradient-to-b from-[color:var(--surface)] via-[color:var(--surface-alt)]/40 to-[color:var(--surface)]" aria-label="Users list"></ul>
  </div>
</div>

<div class="mt-6 glass p-5 rounded-2xl border border-[color:var(--border)]/60 shadow-lg shadow-black/5 dark:shadow-black/30" id="linkPanel" hidden>
  <h2 class="font-semibold mb-3 text-lg flex items-center gap-2">Selected <span class="text-[10px] uppercase tracking-wide px-2 py-0.5 rounded-full bg-[color:var(--brand-100)] dark:bg-[color:var(--brand-900)] text-[color:var(--brand-600)] dark:text-[color:var(--brand-300)]">Context</span></h2>
  <div class="grid sm:grid-cols-2 gap-4 text-sm">
    <div class="space-y-1">
      <p class="text-xs uppercase tracking-wide muted">Surgeon</p>
      <p class="font-medium" id="selSurgeon"></p>
      <p id="selSurgeonDesc" class="text-xs muted line-clamp-3"></p>
      <div id="selSurgeonUser" class="mt-2 text-xs hidden">
        <p class="uppercase tracking-wide font-semibold mb-1">Linked User</p>
        <div class="rounded border border-[color:var(--border)] px-2 py-1 bg-[color:var(--surface-alt)]/50 flex flex-col gap-1">
          <div class="flex items-center justify-between gap-2">
            <span id="surgeonUserName" class="font-medium text-[13px] truncate"></span>
            <button id="surgeonInlineUnlink" class="btn btn-ghost px-2 py-0.5 text-[11px]" title="Unlink this surgeon from user">Unlink</button>
          </div>
          <span id="surgeonUserEmail" class="muted text-[11px] truncate"></span>
        </div>
      </div>
    </div>
    <div class="space-y-1">
      <p class="text-xs uppercase tracking-wide muted">User</p>
      <p class="font-medium" id="selUser"></p>
      <p class="text-[11px] muted" id="selUserStatus"></p>
      <div id="selUserSurgeons" class="mt-2 text-xs hidden">
        <p class="uppercase tracking-wide font-semibold mb-1 flex items-center gap-2">Linked Surgeons <span id="userSurgeonCount" class="badge bg-[color:var(--brand-600)] text-white text-[10px] px-2 py-0.5 rounded-full"></span></p>
  <ul id="userSurgeonsList" class="max-h-40 overflow-auto rounded border border-[color:var(--border)] divide-y divide-[color:var(--border)] bg-[color:var(--surface-alt)]/40 text-[12px]"></ul>
      </div>
    </div>
  </div>
  <div class="flex flex-wrap gap-3 mt-4">
    <button id="linkBtn" class="btn btn-primary text-sm">Link</button>
    <button id="unlinkBtn" class="btn btn-ghost text-sm">Unlink</button>
    <button id="clearSel" class="btn btn-ghost text-sm">Clear</button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/link_surgeons.js') }}" defer></script>
{% endblock %}