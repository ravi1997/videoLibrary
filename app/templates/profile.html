{% extends "layout.html" %}
{% block title %}Profile Â· RPC Surgical Video Library{% endblock %}

{% block content %}
<!-- Page header -->
<div class="flex flex-col justify-between items-center">
    <div class="w-1/2">

        <section class="mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div class="flex items-center gap-4">
                    <div id="avatarWrap"
                        class="w-16 h-16 rounded-full bg-[color:var(--brand-100)] overflow-hidden flex items-center justify-center">
                        <img id="avatarImg" class="w-full h-full object-cover hidden" alt="Avatar" />
                        <span id="avatarFallback" class="text-xl font-bold text-[color:var(--brand-700)]">U</span>
                    </div>
                    <div>
                        <h1 id="profName" class="text-2xl font-extrabold text-[color:var(--text)]">Your Profile</h1>
                        <p id="profSub" class="muted text-sm">Loading account detailsâ€¦</p>
                    </div>
                </div>

                <!-- Quick actions -->
                <div class="flex items-center gap-2">
                    <a href="/favourites" class="btn btn-primary no-underline">ðŸ’– Favourites</a>
                    <button id="editBtn"
                        class="hidden btn-ghost px-3 py-2 rounded-lg border border-[color:var(--border)]">Edit</button>
                </div>
            </div>
        </section>

        <!-- Stats -->
        <section class="mb-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="card p-4">
                <div class="text-sm muted">Favourites</div>
                <div id="statFaves" class="text-2xl font-bold text-[color:var(--text)]">â€”</div>
            </div>
            <div class="card p-4">
                <div class="text-sm muted">Watched</div>
                <div id="statWatched" class="text-2xl font-bold text-[color:var(--text)]">â€”</div>
            </div>
        </section>

        <!-- Main content -->
        <section class="grid grid-cols-1 lg:grid-cols-[2fr,1fr] gap-6">
            <!-- Right: profile card -->
            <aside class="card p-4 space-y-4">
                <h3 class="text-lg font-bold text-[color:var(--text)]">Account</h3>

                <div class="space-y-2 text-sm">
                    <div class="flex items-center justify-between">
                        <span class="muted">Email</span>
                        <span id="infoEmail" class="font-medium text-[color:var(--text)]">â€”</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="muted">Username</span>
                        <span id="infoUsername" class="font-medium text-[color:var(--text)]">â€”</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="muted">Mobile</span>
                        <span id="infoMobile" class="font-medium text-[color:var(--text)]">â€”</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="muted">Roles</span>
                        <span id="infoRoles" class="font-medium text-[color:var(--text)]">â€”</span>
                    </div>
                </div>

                <hr class="hr" />

                <div class="space-y-2">
                    <a class="btn-ghost w-full text-center px-3 py-2 rounded-lg border border-[color:var(--border)] no-underline"
                        href="javascript:void(0)" onclick="onLogoutClick()">Logout</a>
                    <a class="hidden btn-ghost w-full text-center px-3 py-2 rounded-lg border border-[color:var(--danger)] text-[color:var(--danger)] no-underline"
                        href="/delete-account">Delete account</a>
                </div>
            </aside>
        </section>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    async function onLogoutClick() {
            // Try to notify server; ignore failures
            const token = localStorage.getItem("token");
            try {
                await fetch("/api/v1/auth/logout", {
                    method: "POST",
                    headers: token ? { "Authorization": `Bearer ${token}` } : {},
                });
                localStorage.removeItem("token");
                localStorage.removeItem("user");
            } catch {
                // ignore
            }
            // Redirect to login (or home if you prefer)
            try { window.location.assign("/login"); } catch { window.location.href = "/login"; }
        }
    (function () {
        // --- helpers
        const $ = (s, r = document) => r.querySelector(s);
        const getToken = () => localStorage.getItem("token") || "";
        const withAuth = (opts = {}) => ({
            ...opts,
            headers: {
                "Accept": "application/json",
                "Content-Type": "application/json",
                ...(opts.headers || {}),
                ...(getToken() ? { "Authorization": "Bearer " + getToken() } : {}),
            }
        });

        // --- endpoints (adjust if different)
        const API = {
            me: "/api/v1/auth/me",
            // updateAccount: "/api/v1/auth/profile",
            // changePassword: "/api/v1/auth/change-password",
            stats: "/api/v1/video/stats" // expect {favorites, watched, playlists}
        };

        // --- DOM refs
        const profName = $("#profName");
        const profSub = $("#profSub");
        const avatarImg = $("#avatarImg");
        const avatarFallback = $("#avatarFallback");

        const statFaves = $("#statFaves");
        const statWatched = $("#statWatched");
        // const statPlaylists = $("#statPlaylists");

        const formAccount = $("#formAccount");
        // const inpName = $("#inpName");
        // const inpUsername = $("#inpUsername");
        // const inpEmail = $("#inpEmail");
        // const inpMobile = $("#inpMobile");
        // const inpRoles = $("#inpRoles");
        // const saveAccount = $("#saveAccount");
        // const cancelAccount = $("#cancelAccount");
        const accountMsg = $("#accountMsg");

        const infoEmail = $("#infoEmail");
        const infoUsername = $("#infoUsername");
        const infoMobile = $("#infoMobile");
        const infoRoles = $("#infoRoles");

        const formSecurity = $("#formSecurity");
        const secCurrent = $("#secCurrent");
        const secNew = $("#secNew");
        const secNew2 = $("#secNew2");
        const savePassword = $("#savePassword");
        const secMsg = $("#secMsg");

        const formPrefs = $("#formPrefs");
        const prefAutoplay = $("#prefAutoplay");
        const prefMsg = $("#prefMsg");

        // --- tabs
        document.querySelectorAll(".tab-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const tab = btn.getAttribute("data-tab");
                document.querySelectorAll(".tab-btn").forEach(b => b.setAttribute("aria-selected", String(b === btn)));
                document.querySelectorAll(".tab-panel").forEach(p => {
                    p.classList.toggle("hidden", p.getAttribute("data-tab") !== tab);
                });
            });
        });
        function escapeHtml(s) {
            return String(s)
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#039;");
        }
        // --- load profile
        async function loadProfile() {
            try {
                const res = await fetch(API.me, withAuth({ method: "GET" }));
                if (res.status === 401) return location.href = "/login";
                const data = await res.json();
                // shape: { logged_in_as: { id, username, email, mobile, name?, roles, avatarUrl? } }
                const u = data.logged_in_as || data.user || data;

                // header
                profName.textContent = u.name || u.username || "Your Profile";
                profSub.textContent = u.email || "";

                // avatar
                if (u.avatarUrl) {
                    avatarImg.src = u.avatarUrl;
                    avatarImg.classList.remove("hidden");
                    avatarFallback.classList.add("hidden");
                } else {
                    avatarFallback.textContent = (u.name || u.username || "U").slice(0, 1).toUpperCase();
                    avatarImg.classList.add("hidden");
                    avatarFallback.classList.remove("hidden");
                }

                // right card
                infoEmail.textContent = u.email || "â€”";
                infoUsername.textContent = u.username || "â€”";
                infoMobile.textContent = u.mobile || "â€”";
                if (Array.isArray(u.roles) && u.roles.length) {
                    infoRoles.innerHTML = u.roles.map(r => {
                        const clean = String(r).replace(/^Role\./, ""); 
                        return `
                        <span class="chip inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-[color:var(--brand-50)] text-[color:var(--brand-700)] mr-1 mb-1">
                        ${escapeHtml(clean)}
                        </span>
                    `;}).join("");
                } else {
                    infoRoles.innerHTML = `<span class="muted">â€”</span>`;
                }
            } catch (e) {
                profSub.textContent = "Could not load profile.";
                console.error(e);
            }
        }

        // --- load stats
        async function loadStats() {
            try {
                const res = await fetch(API.stats, withAuth({ method: "GET" }));
                if (!res.ok) throw new Error("stats http " + res.status);
                const s = await res.json();
                statFaves.textContent = s.favorites ?? s.favourites ?? "0";
                statWatched.textContent = s.watched ?? "0";
                // statPlaylists.textContent = s.playlists ?? "0";
            } catch {
                statFaves.textContent = "â€”";
                statWatched.textContent = "â€”";
                // statPlaylists.textContent = "â€”";
            }
        }


        loadProfile();
        loadStats();
    })();
</script>
{% endblock %}