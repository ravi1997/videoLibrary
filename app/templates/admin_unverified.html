{% extends 'layout.html' %}
{% block title %}Pending Verification - Admin{% endblock %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">Users Pending Verification</h1>
<div id="unverifiedContainer" class="space-y-4"></div>

<template id="userRowTemplate">
  <div class="p-4 rounded border flex flex-col sm:flex-row sm:items-center gap-4 bg-white dark:bg-gray-800 shadow">
    <div class="flex-1 text-sm leading-relaxed">
      <div class="font-medium text-lg username"></div>
      <div class="grid grid-cols-2 gap-x-6 gap-y-1 mt-2">
        <div><span class="label">Email:</span> <span class="email"></span></div>
        <div><span class="label">Mobile:</span> <span class="mobile"></span></div>
        <div><span class="label">Employee ID:</span> <span class="employee_id"></span></div>
        <div><span class="label">Type:</span> <span class="user_type capitalize"></span></div>
        <div><span class="label">Document:</span> <span class="document_submitted"></span></div>
        <div><span class="label">Created:</span> <span class="created_at"></span></div>
      </div>
    </div>
    <div class="flex flex-row gap-2 items-center">
      <button class="viewDocBtn btn btn-secondary" title="View uploaded document">Document</button>
      <button class="verifyBtn btn btn-primary">Verify</button>
      <button class="discardBtn btn btn-danger" title="Discard user">Discard</button>
    </div>
  </div>
</template>

<script>
async function fetchUnverified() {
  const res = await fetch('/api/v1/auth/unverified', { credentials: 'include' });
  if (!res.ok) {
    document.getElementById('unverifiedContainer').innerHTML = '<div class="text-red-600">Failed to load users</div>';
    return;
  }
  const data = await res.json();
  const wrap = document.getElementById('unverifiedContainer');
  wrap.innerHTML = '';
  if (!data.users.length) {
    wrap.innerHTML = '<div class="p-6 border rounded bg-green-50 dark:bg-green-900/30">All caught up — no pending users.</div>';
    return;
  }
  const tpl = document.getElementById('userRowTemplate');
  data.users.forEach(u => {
    const node = tpl.content.cloneNode(true);
    node.querySelector('.username').textContent = u.username || '(no username)';
    node.querySelector('.email').textContent = u.email || '—';
    node.querySelector('.mobile').textContent = u.mobile || '—';
    node.querySelector('.employee_id').textContent = u.employee_id || '—';
    node.querySelector('.user_type').textContent = u.user_type || '—';
    node.querySelector('.document_submitted').textContent = u.document_submitted ? 'Yes' : 'No';
    node.querySelector('.created_at').textContent = u.created_at ? new Date(u.created_at).toLocaleString() : '—';
    const verifyBtn = node.querySelector('.verifyBtn');
    verifyBtn.addEventListener('click', () => verifyUser(u.id, verifyBtn));
    const docBtn = node.querySelector('.viewDocBtn');
    docBtn.addEventListener('click', () => viewDocument(u.id, docBtn));
    if(!u.document_submitted){
      docBtn.disabled = true;
      docBtn.title = 'No document uploaded';
    }
    const discardBtn = node.querySelector('.discardBtn');
    discardBtn.addEventListener('click', () => discardUser(u.id, discardBtn));
    wrap.appendChild(node);
  });
}

async function verifyUser(id, btn) {
  btn.disabled = true;
  btn.textContent = 'Verifying...';
  try {
    const res = await fetch('/api/v1/auth/verify-user', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ user_id: id })
    });
    const data = await res.json();
    if (!res.ok || data.msg !== 'verified') {
      alert(data.msg || 'Verification failed');
      btn.disabled = false;
      btn.textContent = 'Verify';
      return;
    }
    btn.textContent = 'Verified';
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-success');
    // Remove card after short delay
    setTimeout(fetchUnverified, 600);
  } catch (e) {
    console.error(e);
    alert('Network error');
    btn.disabled = false;
    btn.textContent = 'Verify';
  }
}

async function viewDocument(id, btn){
  btn.disabled = true;
  try {
    const win = window.open(`/api/v1/auth/user-document/${id}`, '_blank');
    if(!win){ alert('Popup blocked. Allow popups to view document.'); }
  } finally {
    btn.disabled = false;
  }
}

async function discardUser(id, btn){
  if(!confirm('Discard this user? This cannot be undone.')) return;
  btn.disabled = true;
  btn.textContent = 'Discarding...';
  try {
    const res = await fetch('/api/v1/auth/discard-user', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ user_id: id })
    });
    const data = await res.json();
    if(!res.ok){
      alert(data.msg || 'Discard failed');
      btn.disabled = false; btn.textContent='Discard';
      return;
    }
    setTimeout(fetchUnverified, 300);
  } catch(e){
    console.error(e);
    alert('Network error');
    btn.disabled = false; btn.textContent='Discard';
  }
}

fetchUnverified();
</script>
{% endblock %}
